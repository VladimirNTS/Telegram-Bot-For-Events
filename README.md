# Телеграм бот для огранизации мероприятий

## Архитектура админ-панели и логика системы

### 0. Назначение документа
**Документ описывает:**
- структуру админ-панели
- сущности системы
- основные пользовательские сценарии
- связи между Telegram-ботом и админкой

**Документ используется:**
- дизайнером для построения экранов и UX
- разработчиком как логическая карта системы

### 1. Архитектура системы
**Компоненты:**
- Telegram Bot (UI + уведомления)
- Web Admin Panel (основная логика)
- База данных
- Платёжный провайдер (Ю-Касса)
- Backend API (связывает базу данных, оплату и интерфейс)

Принцип:
Вся бизнес-логика и решения - в админке
Бот - только клиент

### 2. Структура работы админ панели
**Левое меню с разделами**:
- Главаня страница (Дашборд)
- Мероприятия
- Регистрации
- Заявки выcтавки
- Заявки партнеры
- Пользователи
- Очередь
- Платежи
- Документы
- Отзывы
- Уведомление
- QR-коды
- Чёрный список
- Настройки 

#### 2.1. Главная страница (Дашборд)
Страница дашборда разделена На блоки с базовой статистикой. 
- Блок "Новые заявки" - количество новых заявок за последние 24 часа.
- Блок "Ожидают оплаты" - количество и ссыма всех подтвержденных и не оплаченых заявок на выставку
- Блок "Очередь" - количество не обработанных заявок на выставку
- Таблица "Ближайшие мероприятия" - список мероприятий на следующие семь дней.
- Таблица "Последнии регистрации" - последнии 5 регистраций на выставку и их статусы

**Также должны быть кнопки**
- "Создать мероприятие" - открывает форму создания мероприятия (описана ниже)
- "Скачать QR бота" - скачивает самый базовый QR код на бота

#### 2.2. Мероприятия
На этой вкладке можно просматривать все мероприятия, изменять их, создавать новые, удалять.

##### Таблица мероприятий
Табллица со списком всех мероприятий с фильтрами по дате, разделу, статусу, платно/бесплатно и поиск по названию. У каждого мероприятия должна быть кнопка редактирования и удаления. При удаление, если мероприятие бесплатное, то оно удалиться без проблем, а участникам отправиться уведомление об отменене, если платное, то статус перейдет в отменено и новые записи не будут приниматься, но можно будет проматривать всех пользователей, чтобы вернуть деньги.

##### Создание мероприятий
Мероприятие создаеться по кнопке в правом верхнем углу. После этого откроеться форма, в которой нуно будет заполнить:
- Название мероприятия
- Дату и время начала мероприятия
- выбрать раздел (бизнес мероприятия или клуб молодых семей)
- Место проведения
- описание
- Условия участия (просто текст, который выдаст бот пользователю перед записью)
- Анкета, указать какие поля нужны для анкеты. В зависимости от раздела ставяться по умолчанию с возможностью добавить новые:
  Анкета по умолчанию для клуба молодых семей:
  - Имя
  - телефон
  - Количество детей
  - Город / район (не обязательное)
  
  Анкета по умолчанию для бизнес мероприятия:
  - Имя
  - телефон
  - сфера деятельности
  - Город / район
 
- Стоимость участия (если бесплатно, то просто 0)
- Часовой пояс (по умолчанию береться из настроик проекта)

#### 2.3. Регистрации

На этой вкладке отображаются все записи пользователей на мероприятия Клуба молодых семей и Бизнес мероприятий.

##### Таблица регистраций

Таблица со списком всех регистраций.

Фильтры:
- мероприятие
- раздел (Клуб молодых семей / Бизнес мероприятия)
- статус регистрации (подтверждён / в листе ожидания / отменён)
- статус оплаты (ожидает оплаты / оплачено / возврат / ошибка)
- дата регистрации
- поиск по имени или телефону

Колонки:
- Имя
- Телефон
- Мероприятие
- Раздел
- Статус регистрации
- Статус оплаты
- Дата регистрации
- Кнопка просмотра

##### Карточка регистрации

Карточка регистрации содержит:
- все данные анкеты пользователя
- статус регистрации
- статус оплаты
- историю изменений
- дату и время регистрации
- информацию о нахождении в очереди (если применимо)

Кнопки:
- Подтвердить вручную
- Отменить участие
- Связаться (переход в Telegram)

При отмене участия:
- место освобождается
- автоматически запускается логика приглашения следующего пользователя из очереди

#### 2.4. Заявки в партнеры
Таблица всех заявок в партнеры с фильтрами по: 
- дате
- направлению(KMC / бизнес / оба)
- формату сотрудничества

Карточка заявки содержит: 
- ФИО или название
- telegram username
- Номер телефона 
- интересующее направление
- формат сотрудничества
- Чем полезен аудитории
- Коментарий заявителя

Кнопки карточки:
- связаться (перенаправляет в телеграм)
- принять
- отклонить

#### 2.5. Заявки на выставки
Таблица всех заявок на выставки с фильтрами по: 
- дате
- что планируют предоставить (товары, еда, услуги, МК, другое)
- нужна ли поддержка "Мой бизнес"

Карточка заявки содержит: 
- Статус участника (ИП/OOO или физическое лицо)
- Название компании 
- Контактное лицо 
- интересующее направление
- формат сотрудничества
- Чем полезен аудитории
- Коментарий заявителя

Кнопки карточки:
- связаться (перенаправляет в телеграм)
- принять
- отклонить

Для принятия нужно заполнить форму. После чего сообщение о подтверждении отправиться заявителю.
- Формат участия
- Стоимость
- Сумма к оплате


#### 2.6. Пользователи

Раздел предназначен для хранения и управления базой пользователей.

##### Таблица пользователей

Фильтры:
- выбранный раздел
- дата регистрации
- поиск по имени / телефону / telegram id

Колонки:
- Имя
- Телефон
- Telegram ID
- Выбранный раздел (Клуб молодых семей, бизнес, выставка, партнер)
- Количество мероприятий
- Последняя активность
- Статус

##### Карточка пользователя

Содержит:
- Все данные из колонок
- история регистраций
- история оплат
- оставленные отзывы
- заметки администратора
- статус в чёрном списке

Кнопки:
- Удалить из черного списка / Добавить в черный список
- Перейти в Telegram

#### 2.7. Очередь

Раздел предназначен для управления листами ожидания.

##### Общий список очередей

Отображаются мероприятия, у которых есть активная очередь.

Колонки:
- Мероприятие
- Раздел
- Количество человек в очереди
- Количество приглашённых
- Кнопка просмотра

##### Очередь конкретного мероприятия

Отображается список пользователей в порядке очереди.

Колонки:
- Позиция
- Имя
- Телефон
- Статус (ожидает / приглашён / истёк срок)
- Время приглашения
- Время окончания 16 часов

Администратор может:
- удалить пользователя из очереди
- пригласить вручную
- продлить время ожидания

#### 2.8. Платежи

Раздел предназначен для контроля всех оплат. По мимо таблице также будет статистика на месяц: сколько было оплат, на какую сумму и сколько отмен

##### Таблица платежей

Фильтры:
- мероприятие
- раздел
- статус (ожидает / оплачено / возврат / ошибка)
- дата
- поиск по имени или телефону

Колонки:
- Имя
- Мероприятие
- Сумма
- Статус
- Дата создания
- Способ оплаты

##### Карточка платежа

Содержит:
- данные пользователя
- данные мероприятия
- сумма
- статус
- id транзакции в Ю-Касса
- лог изменений статуса

Возвраты производятся вручную через Ю-Касса, после чего в админке нужно будет указать что оплата отменена.

#### 2.9. Документы

Раздел предназначен для генерации и хранения документов.

##### Шаблоны документов

Возможность:
- загрузить шаблон договора
- загрузить шаблон счёта
- загрузить шаблон акта
- указать переменные для автоподстановки

##### Список документов

Фильтры:
- тип документа
- статус
- дата создания
- мероприятие

Колонки:
- Тип
- Контрагент
- Мероприятие
- Статус
- Дата создания
- Кнопка скачать

Документы могут автоматически отправляться пользователю в Telegram после генерации.

#### 2.10. Отзывы

Раздел предназначен для просмотра обратной связи.

##### Таблица отзывов

Фильтры:
- мероприятие
- раздел
- оценка
- дата

Колонки:
- Имя
- Мероприятие
- Оценка
- Текст отзыва
- Дата

#### 2.11. Уведомления

Раздел предназначен для управления текстами сообщений и рассылкой

Будет две вкладки: рассылка и сообщения

##### Рассылка
Не большая форма:
- Текст сообщения
- Фото 1-10 штук (Опционально)
- Видео (Опционально)
- Голосовое (Опционально)
- Категория кому отправлять (всем, клубу молодых семей, бизнес мероприятия, партнеры или участникам определнных мероприятий)
- Кнопка отправить

##### Сообщения 
В этом разделе редактируються тексты сообщений

Можно редактировать:
- напоминание за 48 часов
- напоминание за 24 часа
- напоминание за 3 часа
- напоминание за 1 час
- сообщение о подтверждении регистрации
- сообщение об отмене мероприятия
- сообщение о приглашении из очереди

Также отображается журнал отправленных уведомлений:
- кому отправлено
- какое сообщение
- дата и время
- статус доставки

#### 2.12. QR-коды

Раздел предназначен для генерации QR-кодов.

Поддержка:
- общий QR на запуск бота
- QR на раздел (Клуб молодых семей / Бизнес мероприятия)
- QR на конкретное мероприятие

Возможность:
- предпросмотр
- скачивание

#### 2.13. Чёрный список

Раздел для управления заблокированными пользователями.

Таблица:
- Имя
- Телефон
- Причина блокировки
- Дата добавления

Пользователь в чёрном списке:
- не может регистрироваться
- не может вставать в очередь

Кнопка добавить пользователя.
- Позваляет выбрать имеющегося пользователя из базы или написать номер телефона человека.


#### 2.14 Настройки

В разделе настроек можно указать:

- Часовой пояс проекта
- Тихие часы для уведомлений
- Ключи интеграции Ю-Касса
- Ссылку на политику обработки персональных данных
- Текст договора публичной оферты

### 3 Структура телеграм бота 
Бот работает с клиентами, пользовательские сценарии и комуникацию с админкой через API.

#### 3.1 Вход в бота
В бота можно зайти прописав просто команду старт, после чего бот предолжит выбрать одну из категорий:
- Клуб молодых семей
- Бизнес мероприятия
- Партнер
- Подать на выставку
Выбранный раздел сохраняеться в базе.

Также можно будет зайти в бота через специальную ссылку с параметром ?start={id мероприятия}. Таким образом пользователь сразу попадет на нужное мероприятие.
QR коды это теже ссылки, только зашифрованные в картинку. Они будут работать точно также.

#### 3.2 Мероприятия
Если клиент выбрал клуб молодых семей или бизнес мероприятия, то кнопки в главном меню будут такие:
- Мои записи 
- На сегодня
- На этой неделе
- Ближайшие 
- Сменить раздел
- Поддержка

##### 3.2.1 Посмотреть мои записи
Отображает пользователю список всех мероприятий на которые он зарегестрирован, поля:
- Название мероприятия
- Статус (если человек стоит в очереди)
- Дата мероприятия 
- Время мероприятия
- Место мероприятия

Кнопки к каждой карточке:
- Отменить - отменяет запись, в админке статус меняеться на возврат. После возврата средств, статус в админке нужно будет менять в ручную

##### 3.2.2 Мероприятия на сегодня
Отправляет пользователю карточки всех мероприятий на сегодня, которые еще не начались.

Поля карточек:
- Название мероприятия
- Описание мероприятия
- Дата мероприятия
- Время мероприятия
- Место мероприятия
- Платно / бесплатно
- Стоимость участия
- Свободные места 

Кнопки:
- Записаться (если есть свободные места)
- встать в очередь (если мест нет)

**Запись на клу молодых семей:**
Для записи бот проведет пользователя по нескольким вопросам.
- ФИО 
- Количество детей
- Возраст каждого через пробел. Бот подсчитает средний возраст и он будет отображаться в админке
- Телефон
- Если мероприятие платное и это именно запись, а не очередь, то отправляет счет на оплату.

**Бизнес мероприятие:**
Для записи бот проведет пользователя по нескольким вопросам.
- ФИО 
- Телефон
- Сфера деятельности
- Если мероприятие платное и это именно запись, а не очередь, то отправляет счет на оплату.

После этого пользователь сохраняеться в базе. У него в боте добавляеться запись в "Мои мероприятия"

Если человек стоит в очереди, то когда места появяться, бот напишет пользователю о том что для него появилась место и отправит кнопку оплатить, если мероприятие бесплатное, то кнопка "подтвердить". Если в течение 24 часов не подтвердил, очередь идет к следующему.

#### 3.3 Сменить раздел
Бот отправляет меню как в самом начале

#### 3.4 Поддержка
Этот раздел содержит часто задаваемые вопросы. И кнопку написать в поддержку. При нажатие на нее, бот просит пользователя написать свой запрос и он отправляеться в админку. После ответа в админке, бот  пересылает его пользователю с кнопкой "ответить", чтобы продолжить диалог и кнопкой "Закрыть диалог".

#### 3.5 Партнеры
Если пользователь выбирает раздел "Партнер" в боте:

Экран 1:
Краткое описание условий сотрудничества.
Кнопка: 
- подать заявку
- Сменить раздел

Экран 2 - Анкета:
- Кто вы (эксперт / бренд / компания)
- ФИО или название
- Контакт
- Телефон
- Email
- Интересующее направление (Клуб молодых семей / Бизнес мероприятия / оба)
- Формат сотрудничества (платно / бартер / выступление)
- Чем полезны аудитории
- Комментарий

После отправки:
- Заявка сохраняется в базе
- В админке создается новая заявка со статусом "новая"
- Пользователю отправляется сообщение:
  "Заявка отправлена. Мы свяжемся после рассмотрения."

После решения в админке:
- Если принята - отправляется сообщение с условиями сотрудничества
- Если отклонена - отправляется сообщение об отказе

#### 3.6 Выставки 
Если пользователь выбирает "Подать на выставку":

Экран 1:
Информация о том, что формат участия определяется индивидуально.
Кнопка:
- Подать заявку
- Сменить раздел

Экран 2 - Анкета:
- Статус участника (ИП / ООО / физическое лицо)
- Название компании
- Контактное лицо
- Телефон
- Email
- Описание деятельности
- Что планирует представить (товары / еда / услуги / МК / другое)
- Нужна ли поддержка "Мой бизнес"

После отправки:
- Заявка сохраняется в базе
- В админке создается новая заявка со статусом "новая"
- Пользователю отправляется сообщение:
  "Спасибо. Заявка принята. Ответ будет направлен в этом чате."

После решения в админке:
- Если одобрена:
  - бот отправляет:
    - формат участия
    - стоимость
    - сумму к оплате
    - кнопку подтвердить участие
- Если отказ:
  - бот отправляет сообщение об отказе


### 4 Стек для разработки
**Python** - осноывной язык програмирования.
#### Модули
**Aiogram** - для разработки тг бота
**fastapi** - API, серверная часть админки и приема оплата
**HTML/CSS/BootStrap** - Верстка админ панели
**HTTPX** - для создания оплата через API Ю-Касса
**SQLAlchemy** - для работы с базой данных 
**PostgreSPL** - База данных

### 5 Модели таблиц
users:
- id: UUID - Основное id пользователя
- telegram_id: BIGINT - Telegram ID
- username: VARCHAR - Telegram username
- full_name: VARCHAR - Имя пользователя
- phone: VARCHAR - Номер телефона
- selected_section: VARCHAR - Выбранный раздел (kmc / business / partner / exhibition)
- registrations_count: INTEGER - Количество регистраций
- last_activity_at: TIMESTAMP - Последняя активность
- is_blacklisted: BOOLEAN - В черном списке или нет
- created_at: TIMESTAMP - Дата регистрации в системе
- updated_at: TIMESTAMP - Дата обновления

events:
- id: UUID - ID мероприятия
- title: VARCHAR - Название мероприятия
- section: VARCHAR - Раздел (kmc / business)
- description: TEXT - Описание
- participation_conditions: TEXT - Условия участия
- location: VARCHAR - Место проведения
- start_datetime: TIMESTAMP - Дата и время начала
- timezone: VARCHAR - Часовой пояс
- price: NUMERIC - Стоимость участия
- max_participants: INTEGER - Максимальное количество участников
- is_active: BOOLEAN - Активно ли мероприятие
- status: VARCHAR - Статус (active / cancelled / finished)
- created_at: TIMESTAMP - Дата создания
- updated_at: TIMESTAMP - Дата обновления

event_form_fields:
- id: UUID - ID поля
- event_id: UUID - ID мероприятия
- field_name: VARCHAR - Название поля
- field_type: VARCHAR - Тип поля (text / number / phone)
- is_required: BOOLEAN - Обязательное ли поле
- sort_order: INTEGER - Порядок отображения

registrations:
- id: UUID - ID регистрации
- user_id: UUID - Пользователь
- event_id: UUID - Мероприятие
- status: VARCHAR - Статус (confirmed / waiting / cancelled)
- payment_status: VARCHAR - Статус оплаты (pending / paid / refund / error)
- queue_position: INTEGER - Позиция в очереди (если есть)
- invited_at: TIMESTAMP - Время приглашения из очереди
- invitation_expires_at: TIMESTAMP - Время окончания приглашения
- created_at: TIMESTAMP - Дата регистрации
- updated_at: TIMESTAMP - Дата обновления

registration_answers:
- id: UUID - ID ответа
- registration_id: UUID - ID регистрации
- field_name: VARCHAR - Название поля
- field_value: TEXT - Значение поля

queue:
- id: UUID - ID записи очереди
- event_id: UUID - Мероприятие
- user_id: UUID - Пользователь
- position: INTEGER - Позиция в очереди
- status: VARCHAR - Статус (waiting / invited / expired / removed)
- invited_at: TIMESTAMP - Время приглашения
- expires_at: TIMESTAMP - Время окончания
- created_at: TIMESTAMP - Дата постановки в очередь

payments:
- id: UUID - ID платежа
- user_id: UUID - Пользователь
- event_id: UUID - Мероприятие
- registration_id: UUID - Регистрация
- amount: NUMERIC - Сумма
- currency: VARCHAR - Валюта
- status: VARCHAR - Статус (pending / paid / refund / error)
- provider: VARCHAR - Провайдер (yookassa)
- provider_payment_id: VARCHAR - ID транзакции в Ю-Касса
- created_at: TIMESTAMP - Дата создания
- updated_at: TIMESTAMP - Дата обновления

partner_applications:
- id: UUID - ID заявки
- user_id: UUID - Пользователь (если есть в системе)
- full_name: VARCHAR - ФИО или название
- telegram_username: VARCHAR - Username
- phone: VARCHAR - Телефон
- email: VARCHAR - Email
- direction: VARCHAR - Направление (kmc / business / both)
- cooperation_format: VARCHAR - Формат сотрудничества
- benefit_description: TEXT - Чем полезен аудитории
- comment: TEXT - Комментарий
- status: VARCHAR - Статус (new / reviewing / accepted / rejected)
- admin_notes: TEXT - Заметки администратора
- cooperation_terms: TEXT - Условия сотрудничества
- price: NUMERIC - Стоимость (если применимо)
- created_at: TIMESTAMP - Дата подачи
- updated_at: TIMESTAMP - Дата обновления

exhibition_applications:
- id: UUID - ID заявки
- user_id: UUID - Пользователь (если есть)
- legal_status: VARCHAR - ИП / ООО / физ лицо
- company_name: VARCHAR - Название компании
- contact_person: VARCHAR - Контактное лицо
- phone: VARCHAR - Телефон
- email: VARCHAR - Email
- activity_description: TEXT - Описание деятельности
- provided_type: VARCHAR - Что предоставляет (товары / еда / услуги / мк / другое)
- need_support: BOOLEAN - Нужна ли поддержка
- participation_format: VARCHAR - Формат участия
- full_price: NUMERIC - Полная стоимость
- support_amount: NUMERIC - Сумма поддержки
- final_amount: NUMERIC - Сумма к оплате
- payment_status: VARCHAR - Статус оплаты
- status: VARCHAR - Статус заявки (new / reviewing / approved / rejected / paid)
- created_at: TIMESTAMP - Дата подачи
- updated_at: TIMESTAMP - Дата обновления

reviews:
- id: UUID - ID отзыва
- user_id: UUID - Пользователь
- event_id: UUID - Мероприятие
- rating: INTEGER - Оценка (1-5)
- text: TEXT - Текст отзыва
- created_at: TIMESTAMP - Дата создания

notifications_log:
- id: UUID - ID уведомления
- user_id: UUID - Пользователь
- message_type: VARCHAR - Тип сообщения
- content: TEXT - Текст сообщения
- status: VARCHAR - Статус доставки
- sent_at: TIMESTAMP - Дата и время отправки

documents:
- id: UUID - ID документа
- user_id: UUID - Пользователь
- event_id: UUID - Мероприятие
- document_type: VARCHAR - Тип (contract / invoice / act)
- file_path: VARCHAR - Путь к файлу
- status: VARCHAR - Статус
- created_at: TIMESTAMP - Дата создания

